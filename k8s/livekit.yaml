# =========================
# LIVEKIT CONFIG TEMPLATE
# =========================
apiVersion: v1
kind: ConfigMap
metadata:
  name: livekit-config-template
  namespace: meet-service
data:
  livekit.yaml: |
    port: 7880
    bind_addresses:
      - "0.0.0.0"
    
    rtc:
      use_external_ip: true
      node_ip: "133.186.213.194"

      port_range_start: 50000
      port_range_end: 50001
      tcp_port: 7881

      stun_servers:
        - stun.l.google.com:19302
        - stun1.l.google.com:19302

      turn_servers:
        - host: 133.186.213.194
          port: 32478
          protocol: udp
          username: ${TURN_USERNAME}
          credential: ${TURN_PASSWORD}
        - host: 133.186.213.194
          port: 32562
          protocol: tcp
          username: ${TURN_USERNAME}
          credential: ${TURN_PASSWORD}

---

# =========================
# LIVEKIT DEPLOYMENT
# =========================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: livekit
  namespace: meet-service
  labels:
    app: livekit
spec:
  replicas: 1
  selector:
    matchLabels:
      app: livekit
  template:
    metadata:
      labels:
        app: livekit
      annotations:
        livekit-refresh: "v2025-10-29-hostnetwork-final"
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet

      volumes:
        - name: config-volume
          emptyDir: {}
        - name: config-template
          configMap:
            name: livekit-config-template

      initContainers:
        - name: config-generator
          image: busybox
          envFrom:
            - secretRef:
                name: livekit-secret
            - secretRef:
                name: coturn-secret
          volumeMounts:
            - name: config-volume
              mountPath: /config
            - name: config-template
              mountPath: /template
          command:
            - sh
            - -c
            - |
              set -eu
              echo "keys:" > /config/livekit.yaml
              echo "  ${LIVEKIT_API_KEY}: ${LIVEKIT_API_SECRET}" >> /config/livekit.yaml
              echo "" >> /config/livekit.yaml
              cat /template/livekit.yaml >> /config/livekit.yaml

      containers:
        - name: livekit
          image: livekit/livekit-server:v1.9.2
          args:
            - --config
            - /config/livekit.yaml
          ports:
            - containerPort: 7880
            - containerPort: 7881
            - containerPort: 50000
            - containerPort: 50001
          volumeMounts:
            - name: config-volume
              mountPath: /config
          envFrom:
            - secretRef:
                name: livekit-secret
            - secretRef:
                name: coturn-secret
