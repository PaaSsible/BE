name: Deploy to NHN

on:
  push:
    branches: [ main ]
    paths:
      - 'user-service/**'
      - 'board-service/**'
      - 'common/**'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-paths: ${{ steps.detect.outputs.paths }}
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: detect
        run: |
          CHANGED_PATHS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          echo "paths=$CHANGED_PATHS" >> $GITHUB_OUTPUT
          echo "Changed paths: $CHANGED_PATHS"

  user-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: contains(needs.detect-changes.outputs.changed-paths, 'user-service/') || contains(needs.detect-changes.outputs.changed-paths, 'common/')
    steps:
      - name: Call NHN Pipeline API (User Service)
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "X-NHN-REGION: KR1" \
            -H "X-NHN-APPKEY: ${{ secrets.NHN_APPKEY }}" \
            -H "X-TC-AUTHENTICATION-ID: ${{ secrets.NHN_ACCESS_KEY }}" \
            -H "X-TC-AUTHENTICATION-SECRET: ${{ secrets.NHN_SECRET_KEY }}" \
            "https://api-pipeline.cloud.toast.com/api/anchor/v1.0/pipelines/contest-18-pipeline-1/execute"

  board-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: contains(needs.detect-changes.outputs.changed-paths, 'board-service/') || contains(needs.detect-changes.outputs.changed-paths, 'common/')
    steps:
      - name: Call NHN Pipeline API (Board Service)
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "X-NHN-REGION: KR1" \
            -H "X-NHN-APPKEY: ${{ secrets.NHN_APPKEY }}" \
            -H "X-TC-AUTHENTICATION-ID: ${{ secrets.NHN_ACCESS_KEY }}" \
            -H "X-TC-AUTHENTICATION-SECRET: ${{ secrets.NHN_SECRET_KEY }}" \
            "https://api-pipeline.cloud.toast.com/api/anchor/v1.0/pipelines/contest-18-pipeline-2/execute"
